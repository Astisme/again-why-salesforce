name: Create all Releases

on:
    pull_request:
        types:
            - closed
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write

jobs:
    setup-and-build:
        runs-on: ubuntu-latest
        steps:
            - name: Define prefix
              run: echo "AWSF=awsf" >> $GITHUB_ENV

            - name: Define file names no version
              run: |
                  echo "CHROME=${{ env.AWSF }}-chrome" >> $GITHUB_ENV
                  echo "FIREFOX=${{ env.AWSF }}-firefox" >> $GITHUB_ENV
                  echo "SAFARI=${{ env.AWSF }}-safari" >> $GITHUB_ENV

            - name: Setup repo
              uses: actions/checkout@v4

            - name: Extract current version
              id: get_version
              run: |
                  echo "VERSION=$(grep -oP '"version":\s*"\K[0-9.]+' manifest/template-manifest.json)" >> $GITHUB_ENV

            - name: Create versioned directory
              id: make_dir
              run: |
                  DIST=dist/v${{ env.VERSION }}
                  mkdir -p $DIST
                  touch $DIST/.gitkeep
                  echo "DIRECTORY=$DIST" >> $GITHUB_ENV

            - name: Define file names with version
              id: def_file_name
              run: |
                  echo "CHROME_VERSION=${{ env.CHROME }}-v${{ env.VERSION }}" >> $GITHUB_ENV
                  echo "FIREFOX_VERSION=${{ env.FIREFOX }}-v${{ env.VERSION }}" >> $GITHUB_ENV
                  echo "SAFARI_VERSION=${{ env.SAFARI }}-v${{ env.VERSION }}" >> $GITHUB_ENV

            - name: Build Chrome
              uses: ./.github/workflows/build-extension.yml
              with:
                  target_broswer: "chrome"
                  target_file: ${{ env.DIRECTORY }}/${{ env.CHROME_VERSION }}.zip
                  release_notes: "./docs/Release Notes/v${{ env.VERSION }}.md"

            - name: Build Firefox
              uses: ./.github/workflows/build-extension.yml
              with:
                  target_broswer: "firefox"
                  target_file: ${{ env.DIRECTORY }}/${{ env.FIREFOX_VERSION }}.zip
                  release_notes: "./docs/Release Notes/v${{ env.VERSION }}.md"

            - name: Build Safari
              uses: ./.github/workflows/build-extension.yml
              with:
                  target_broswer: "safari"
                  target_file: ${{ env.DIRECTORY }}/${{ env.SAFARI_VERSION }}.zip
                  release_notes: "./docs/Release Notes/v${{ env.VERSION }}.md"
